name: Release (Reusable)

on:
  workflow_call:
    inputs:
      target_branch:
        description: "Stable branch to release from (usually main)"
        required: true
        type: string
    secrets:
      NPM_TOKEN:
        description: "npm token used to publish to the npm registry"
        required: true
    outputs:
      version:
        description: "Released version (x.y.z)"
        value: ${{ jobs.versioning.outputs.version }}
      tag:
        description: "Release tag (vX.Y.Z)"
        value: ${{ jobs.versioning.outputs.tag }}

permissions:
  contents: write

concurrency:
  group: release-pipeline-${{ github.repository }}
  cancel-in-progress: false

jobs:
  versioning:
    uses: winccoa-tools-pack/.github/.github/workflows/versioning-tags-changelog-reusable.yml@main
    with:
      mode: release
      target_branch: ${{ inputs.target_branch }}
      create_tag: false
      push_tag: false
    secrets: inherit

  precheck:
    runs-on: ubuntu-latest
    needs: [versioning]
    outputs:
      prerelease_tag: ${{ steps.find.outputs.prerelease_tag }}
    steps:
      - name: Find matching prerelease for this version
        id: find
        shell: bash
        run: |
          VERSION="${{ needs.versioning.outputs.version }}"
          PREFIX="v$VERSION-"
          REPO="${GITHUB_REPOSITORY}"

          echo "üîé Looking for prerelease tags starting with: $PREFIX"

          PRERELEASE_TAG=$(gh release list --repo "$REPO" --limit 200 \
            --json tagName,isPrerelease,createdAt \
            --jq "[.[] | select(.isPrerelease == true and (.tagName | startswith(\"$PREFIX\"))) ] | sort_by(.createdAt) | reverse | .[0].tagName" 2>/dev/null)

          if [ -z "$PRERELEASE_TAG" ] || [ "$PRERELEASE_TAG" = "null" ]; then
            echo "‚ùå ERROR: No matching prerelease found for version $VERSION (expected tag like v$VERSION-<sha>)"
            echo "Hint: run prerelease workflow on release/v$VERSION first."
            exit 1
          fi

          echo "‚úÖ Found prerelease tag: $PRERELEASE_TAG"
          echo "prerelease_tag=$PRERELEASE_TAG" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  tag:
    uses: winccoa-tools-pack/.github/.github/workflows/versioning-tags-changelog-reusable.yml@main
    needs: [precheck]
    with:
      mode: release
      target_branch: ${{ inputs.target_branch }}
      create_tag: true
      push_tag: true
      force_push_tag: false
    secrets: inherit

  release:
    runs-on: ubuntu-latest
    needs: [versioning, precheck, tag]
    steps:
      - name: Use Node.js 20.x
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          registry-url: "https://registry.npmjs.org"
          scope: "@winccoa-tools-pack"

      - name: Download tested npm tarball from prerelease
        shell: bash
        run: |
          mkdir -p dist
          PRERELEASE_TAG="${{ needs.precheck.outputs.prerelease_tag }}"
          REPO="${GITHUB_REPOSITORY}"

          gh release download --repo "$REPO" "$PRERELEASE_TAG" --pattern "*.tgz" --dir dist

          TARBALL_PATH=$(ls -1 dist/*.tgz 2>/dev/null | head -n 1)
          if [ -z "$TARBALL_PATH" ]; then
            echo "‚ùå ERROR: No .tgz found in prerelease assets for $PRERELEASE_TAG"
            ls -la dist || true
            exit 1
          fi

          echo "üì¶ Downloaded tarball: $TARBALL_PATH"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Publish to npm (dist-tag: latest)"
        # Skip NPM publish on forked repositories (no NPM_TOKEN available)
        if: github.repository == 'winccoa-tools-pack/npm-winccoa-core'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        shell: bash
        run: |
          TARBALL_PATH=$(ls -1 dist/*.tgz 2>/dev/null | head -n 1)
          if [ -z "$TARBALL_PATH" ]; then
            echo "‚ùå ERROR: No .tgz found in dist/"
            exit 1
          fi

          echo "üöÄ Publishing $TARBALL_PATH to npm..."
          npm publish "$TARBALL_PATH" --access public --ignore-scripts

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.tag.outputs.tag }}
          name: ${{ format('Release {0}', needs.tag.outputs.tag) }}
          target_commitish: ${{ inputs.target_branch }}
          body: |
            ${{ needs.versioning.outputs.changelog }}

            ### ‚úÖ Tested Artifact
            - Published from tested pre-release asset: `${{ needs.precheck.outputs.prerelease_tag }}`
            - Published to npm with dist-tag: `latest`
          files: "dist/*.tgz"
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup prereleases for this version
        shell: bash
        run: |
          VERSION="${{ needs.versioning.outputs.version }}"
          PREFIX="v$VERSION-"
          REPO="${GITHUB_REPOSITORY}"

          echo "üßπ Deleting prereleases with tag prefix: $PREFIX"

          TAGS=$(gh release list --repo "$REPO" --limit 200 --json tagName,isPrerelease \
            --jq "[.[] | select(.isPrerelease == true and (.tagName | startswith(\"$PREFIX\"))) ] | .[].tagName")

          if [ -z "$TAGS" ]; then
            echo "‚úÖ No prereleases to delete"
            exit 0
          fi

          for TAG in $TAGS; do
            echo "  - Deleting $TAG"
            gh release delete --repo "$REPO" "$TAG" --yes --cleanup-tag || echo "‚ö†Ô∏è Failed to delete $TAG"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
