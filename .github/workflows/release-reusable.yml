name: Release (Reusable)

on:
  workflow_call:
    inputs:
      target_branch:
        description: "Stable branch to release from (usually main)"
        required: true
        type: string
    secrets:
      NPM_TOKEN:
        description: "npm token used to publish to the npm registry"
        required: true
    outputs:
      version:
        description: "Released version (x.y.z)"
        value: ${{ jobs.versioning.outputs.version }}
      tag:
        description: "Release tag (vX.Y.Z)"
        value: ${{ jobs.versioning.outputs.tag }}

permissions:
  contents: write

concurrency:
  group: release-pipeline-${{ github.repository }}
  cancel-in-progress: false

jobs:
  versioning:
    uses: winccoa-tools-pack/.github/.github/workflows/versioning-tags-changelog-reusable.yml@main
    with:
      mode: release
      target_branch: ${{ inputs.target_branch }}
      create_tag: false
      push_tag: false
    secrets: inherit

  precheck:
    runs-on: ubuntu-latest
    needs: [versioning]
    outputs:
      prerelease_tag: ${{ steps.find.outputs.prerelease_tag }}
    steps:
      - name: Find matching prerelease for this version
        id: find
        shell: bash
        run: |
          VERSION="${{ needs.versioning.outputs.version }}"
          PREFIX="v$VERSION-"
          REPO="${GITHUB_REPOSITORY}"

          echo "üîé Looking for prerelease tags starting with: $PREFIX"

          PRERELEASE_TAG=$(gh release list --repo "$REPO" --limit 200 \
            --json tagName,isPrerelease,createdAt \
            --jq "[.[] | select(.isPrerelease == true and (.tagName | startswith(\"$PREFIX\"))) ] | sort_by(.createdAt) | reverse | .[0].tagName" 2>/dev/null)

          if [ -z "$PRERELEASE_TAG" ] || [ "$PRERELEASE_TAG" = "null" ]; then
            echo "‚ùå ERROR: No matching prerelease found for version $VERSION (expected tag like v$VERSION-<sha>)"
            echo "Hint: run prerelease workflow on release/v$VERSION first."
            exit 1
          fi

          echo "‚úÖ Found prerelease tag: $PRERELEASE_TAG"
          echo "prerelease_tag=$PRERELEASE_TAG" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  tag:
    uses: winccoa-tools-pack/.github/.github/workflows/versioning-tags-changelog-reusable.yml@main
    needs: [precheck]
    with:
      mode: release
      target_branch: ${{ inputs.target_branch }}
      create_tag: true
      push_tag: true
      # This allows the release workflow to overwrite an existing tag if a previous release attempt failed partway through.
      force_push_tag: true
    secrets: inherit

  release:
    runs-on: ubuntu-latest
    needs: [versioning, precheck, tag]
    steps:
      - name: Use Node.js 20.x
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          registry-url: "https://registry.npmjs.org"
          scope: "@winccoa-tools-pack"

      - name: Download and repack tarball with release version
        shell: bash
        run: |
          mkdir -p dist staging
          PRERELEASE_TAG="${{ needs.precheck.outputs.prerelease_tag }}"
          REPO="${GITHUB_REPOSITORY}"
          VERSION="${{ needs.versioning.outputs.version }}"

          echo "üì• Downloading tarball from prerelease: $PRERELEASE_TAG"
          gh release download --repo "$REPO" "$PRERELEASE_TAG" --pattern "*.tgz" --dir staging

          TARBALL_PATH=$(ls -1 staging/*.tgz 2>/dev/null | head -n 1)
          if [ -z "$TARBALL_PATH" ]; then
            echo "‚ùå ERROR: No .tgz found in prerelease assets for $PRERELEASE_TAG"
            ls -la staging || true
            exit 1
          fi

          echo "üì¶ Downloaded tarball: $TARBALL_PATH"

          # Extract, update version, and repack
          # npm tarballs have a "package" folder inside
          echo "üìÇ Extracting tarball..."
          tar -xzf "$TARBALL_PATH" -C staging

          echo "üîß Updating version in package.json to: $VERSION"
          # Use jq to update the version field
          jq --arg version "$VERSION" '.version = $version' staging/package/package.json > staging/package/package.json.tmp
          mv staging/package/package.json.tmp staging/package/package.json

          # Verify the version was updated
          UPDATED_VERSION=$(jq -r '.version' staging/package/package.json)
          echo "‚úÖ Version in package.json is now: $UPDATED_VERSION"

          if [ "$UPDATED_VERSION" != "$VERSION" ]; then
            echo "‚ùå ERROR: Version update failed"
            exit 1
          fi

          # Repack with clean version name
          CLEAN_NAME="winccoa-tools-pack-npm-winccoa-core-${VERSION}.tgz"
          echo "üì¶ Repacking as: dist/$CLEAN_NAME"
          tar -czf "dist/$CLEAN_NAME" -C staging package

          # Verify the new tarball
          echo "üìã Contents of new tarball:"
          tar -tzf "dist/$CLEAN_NAME" | head -20

          # Cleanup staging
          rm -rf staging
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Publish to npm (dist-tag: latest)"
        # Skip NPM publish on forked repositories (no NPM_TOKEN available)
        if: github.repository == 'winccoa-tools-pack/npm-winccoa-core'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        shell: bash
        run: |
          TARBALL_PATH=$(ls -1 dist/*.tgz 2>/dev/null | head -n 1)
          if [ -z "$TARBALL_PATH" ]; then
            echo "‚ùå ERROR: No .tgz found in dist/"
            exit 1
          fi

          echo "üöÄ Publishing $TARBALL_PATH to npm..."
          # Use ./ prefix to ensure npm treats this as a local file path, not a git URL
          npm publish "./$TARBALL_PATH" --access public --ignore-scripts

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.tag.outputs.tag }}
          name: ${{ format('Release {0}', needs.tag.outputs.tag) }}
          target_commitish: ${{ inputs.target_branch }}
          body: |
            ${{ needs.versioning.outputs.changelog }}

            ### ‚úÖ Tested Artifact
            - Published from tested pre-release asset: `${{ needs.precheck.outputs.prerelease_tag }}`
            - Published to npm with dist-tag: `latest`
          files: "dist/*.tgz"
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deprecate pre-release npm versions
        if: github.repository == 'winccoa-tools-pack/npm-winccoa-core'
        shell: bash
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          VERSION="${{ needs.versioning.outputs.version }}"
          PACKAGE="@winccoa-tools-pack/npm-winccoa-core"

          echo "üßπ Deprecating pre-release npm versions for $VERSION..."

          # Get all versions from npm that match the pre-release pattern (e.g., 0.2.1-abc1234)
          PRERELEASE_VERSIONS=$(npm view "$PACKAGE" versions --json 2>/dev/null | \
            jq -r ".[] | select(startswith(\"$VERSION-\"))" 2>/dev/null || echo "")

          if [ -z "$PRERELEASE_VERSIONS" ]; then
            echo "‚úÖ No pre-release npm versions found for $VERSION"
            exit 0
          fi

          for PRERELEASE_VERSION in $PRERELEASE_VERSIONS; do
            echo "  - Deprecating $PACKAGE@$PRERELEASE_VERSION"
            npm deprecate "$PACKAGE@$PRERELEASE_VERSION" "Superseded by stable release $VERSION" || \
              echo "‚ö†Ô∏è Failed to deprecate $PRERELEASE_VERSION"
          done

          echo "‚úÖ Pre-release npm versions deprecated"

      - name: Cleanup GitHub prereleases for this version
        shell: bash
        run: |
          VERSION="${{ needs.versioning.outputs.version }}"
          PREFIX="v$VERSION-"
          REPO="${GITHUB_REPOSITORY}"

          echo "üßπ Deleting GitHub prereleases with tag prefix: $PREFIX"

          TAGS=$(gh release list --repo "$REPO" --limit 200 --json tagName,isPrerelease \
            --jq "[.[] | select(.isPrerelease == true and (.tagName | startswith(\"$PREFIX\"))) ] | .[].tagName")

          if [ -z "$TAGS" ]; then
            echo "‚úÖ No GitHub prereleases to delete"
            exit 0
          fi

          for TAG in $TAGS; do
            echo "  - Deleting $TAG"
            gh release delete --repo "$REPO" "$TAG" --yes --cleanup-tag || echo "‚ö†Ô∏è Failed to delete $TAG"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
