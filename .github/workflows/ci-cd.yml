name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, release/**]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      confirmed_local_tests:
        description: 'I confirm that I have run all integration tests locally and they passed'
        required: true
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write
 
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Use Node.js 20.x
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Run linting
        run: npm run lint && npm run lint:md

  format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Use Node.js 20.x
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Run format check
        run: npm run format:check

  test:
    needs: [format, lint]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        node-version: [20.x, 22.x, 24.x, 25.x]
    env:
      CI: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Build package
        run: npm run build
      - name: Run unit tests
        run: npm run test:unit
        env:
          CI: true

  integration-winccoa:
    name: Integration Tests - WinCC OA
    needs: [test]
    if: ${{ needs.test.result == 'success' }}
    runs-on: ubuntu-latest
    env:
      WORKDIR: /workspace
      IMAGE_NAME: mpokornyetm/winccoa-tools-pack-npm-winccoa-core:npm-winccoa-core
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Set up Swap Space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub (optional)
        shell: bash
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USER }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -n "${DOCKER_USER:-}" ] && [ -n "${DOCKER_PASSWORD:-}" ]; then
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USER" --password-stdin
          else
            echo "Docker credentials not available, attempting to pull public image"
          fi
      - name: Pull WinCC OA image
        shell: bash
        run: |
          set -euo pipefail
          docker pull "$IMAGE_NAME"
      - name: Verify runnable fixture config exists
        shell: bash
        run: |
          set -euo pipefail
          test -f "./test/fixtures/projects/runnable/config/config"
      - name: Install dependencies (host)
        run: npm ci
      - name: Build package (host)
        run: npm run build
      - name: Run WinCC OA container
        shell: bash
        run: |
          set -euo pipefail
          docker run -d --name winccoa-ci \
            --shm-size=2g \
            --memory=6g \
            -v "$GITHUB_WORKSPACE":$WORKDIR:rw \
            -e CI=true \
            -e OAINST=/opt/WinCC_OA \
            -e OAPROJ=$WORKDIR/test/fixtures/projects/runnable \
            -w $WORKDIR \
            "$IMAGE_NAME" bash -lc 'sleep 2'
      - name: Verify Xvfb available
        shell: bash
        run: |
          set -euo pipefail
          docker exec --user root winccoa-ci sh -c 'command -v xvfb-run >/dev/null 2>&1 || (echo "::error::xvfb-run not found in container"; exit 1)'
      - name: Run all integration tests inside container
        shell: bash
        run: |
          set -uo pipefail
          EXIT_CODE=0
          docker exec --user root winccoa-ci sh -c '
            set -e
            echo "Node version: $(node -v)"
            echo "Running all integration tests..."
            xvfb-run -s "-screen 0 1280x1024x24" node --import tsx scripts/run-node-tests.ts test/integration
          ' || EXIT_CODE=$?
          
          if [ "$EXIT_CODE" -eq 137 ]; then
            echo "::warning::Integration tests were killed (exit code 137 - OOM). Ignoring for now, pending memory fix PRs."
            exit 0
          elif [ "$EXIT_CODE" -ne 0 ]; then
            echo "::error::Integration tests failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi
      - name: Collect logs on failure
        if: ${{ failure() }}
        shell: bash
        run: |
          echo "==== docker logs ===="
          docker logs winccoa-ci || true
          echo "==== dmesg (check for OOM Killer) ===="
          dmesg | tail -n 50 || true
      - name: Stop and remove container
        if: ${{ always() }}
        shell: bash
        run: |
          docker rm -f winccoa-ci || true

  required:
    name: CI/CD Pipeline - Required
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs:
      - lint
      - format
      - test
      - integration-winccoa
    steps:
      - name: Verify required jobs
        shell: bash
        run: |
          set -euo pipefail
          RESULTS=(
            "lint:${{ needs.lint.result }}"
            "format:${{ needs.format.result }}"
            "test:${{ needs.test.result }}"
            "integration-winccoa:${{ needs['integration-winccoa'].result }}"
          )
          echo "Job results:"
          printf ' - %s\n' "${RESULTS[@]}"
          FAIL=0
          for r in "${RESULTS[@]}"; do
            status="${r#*:}"
            case "$status" in
              success|skipped)
                ;;
              *)
                echo "::error::Required job did not succeed: $r"
                FAIL=1
                ;;
            esac
          done
          if [ "$FAIL" -ne 0 ]; then
            exit 1
          fi
